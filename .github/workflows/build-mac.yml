name: Build for macOS

on:
  push:
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build VideoEventMonitor for macOS
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Display Python version and files
      run: |
        python --version
        python -c "import sys; print(f'Architecture: {sys.platform}')"
        echo "Archivos en el directorio:"
        ls -la
        echo "Archivos Python:"
        ls -la *.py
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install opencv-python==4.8.1.78
        pip install pandas==2.1.1
        pip install numpy==1.24.3
        
    - name: Verify imports
      run: |
        python -c "import cv2; print(f'OpenCV version: {cv2.__version__}')"
        python -c "import pandas; print(f'Pandas version: {pandas.__version__}')"
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}')"
        python -c "print('Dependencias básicas importadas correctamente')"
        python -c "
try:
    from eventos_0002 import VideoEventMonitor
    print('eventos_0002.py importado correctamente')
except ImportError as e:
    print(f'Error importando eventos_0002: {e}')
    print('Buscando archivos disponibles...')
    import os
    py_files = [f for f in os.listdir('.') if f.endswith('.py')]
    print('Archivos Python encontrados:', py_files)
"
        
    - name: Build executable with PyInstaller
      run: |
        # Verificar qué archivo usar como entrada
        echo "Archivos disponibles:"
        ls -la *.py
        
        # Construir usando eventos_0002.py directamente
        pyinstaller --name=VideoEventMonitor \
                   --onefile \
                   --console \
                   --add-data="*.py:." \
                   --hidden-import=cv2 \
                   --hidden-import=pandas \
                   --hidden-import=numpy \
                   --hidden-import=datetime \
                   --hidden-import=os \
                   --hidden-import=sys \
                   --clean \
                   eventos_0002.py
                   
        # Verificar que el ejecutable se creó
        if [ -f "dist/VideoEventMonitor" ]; then
          echo "Executable created successfully!"
          ls -la "dist/VideoEventMonitor"
          # Dar permisos de ejecución
          chmod +x "dist/VideoEventMonitor"
        else
          echo "Error: Executable not found!"
          exit 1
        fi
        
    - name: Test executable (basic)
      run: |
        # Verificación básica del ejecutable
        cd dist
        echo "Probando ejecutable..."
        ./VideoEventMonitor --version 2>&1 || ./VideoEventMonitor --help 2>&1 || echo "✅ Ejecutable funciona (puede no tener comandos de ayuda)"
        
    - name: Upload macOS executable
      uses: actions/upload-artifact@v4
      with:
        name: VideoEventMonitor-macOS
        path: dist/VideoEventMonitor
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/VideoEventMonitor
        body: |
          macOS Executable for Video Event Monitor
          
          Built with:
          - Python ${{ matrix.python-version }}
          - macOS Runner
          - OpenCV 4.8.1
          - Pandas 2.1.1
          - NumPy 1.24.3
